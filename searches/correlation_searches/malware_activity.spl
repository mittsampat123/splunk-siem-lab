| tstats `security_content_summariesonly` count from datamodel=Endpoint.Processes where Process.process_name="cmd.exe" OR Process.process_name="powershell.exe" OR Process.process_name="wscript.exe" by Process.dest, Process.process_name, _time span=5m
| stats count as process_count, dc(Process.process_name) as unique_processes by Process.dest
| where process_count >= 10
| `security_content_ctime(process_count)`
| `drop_dm_object_name(Process)`
| join type=left Process.dest [
| tstats `security_content_summariesonly` count from datamodel=Network_Traffic.Network_Traffic where Network_Traffic.dest_port=80 OR Network_Traffic.dest_port=443 by Network_Traffic.src, _time span=5m
| stats sum(count) as network_connections by Network_Traffic.src
| where network_connections > 20
| `drop_dm_object_name(Network_Traffic)`
| ]
| eval malware_score=case(process_count>=50, 90, process_count>=25, 80, process_count>=10, 70)
| eval threat_type="malware_activity"
| eval description="Suspicious process activity detected on host: " + Process.dest + " with " + process_count + " suspicious processes"
| eval severity=case(malware_score>=80, "high", malware_score>=70, "medium", 1=1, "low")
| eval risk_score=malware_score
| table _time, Process.dest, process_count, unique_processes, network_connections, malware_score, severity, threat_type, description, risk_score
